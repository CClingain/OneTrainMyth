---
title: "Analysis"
author: "Clare Clingain"
date: "April 22, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(lubridate)

# ferry data
#load("Data/Ferry/Clean/ferry_2018.RData")
# mta data
#load("Data/Clean/jan_clean.RData")
#load("Data/Clean/feb_clean.RData")
#load("Data/Clean/march_clean.RData")
#load("Data/Clean/april_clean.RData")
#load("Data/Clean/may_clean.RData")
#load("Data/Clean/june_clean.RData")
#load("Data/Clean/july_clean.RData")
#load("Data/Clean/aug_clean.RData")
```

# Merge and Unlist MTA data

```{r merge mta}
mta_master <- c(jan_clean, feb_clean, march_clean, april_clean, may_clean, june_clean, july_clean, aug_clean)

mta_master2 <- NULL

for(i in 56544:length(mta_master)){
  if(is.null(mta_master[[i]])==TRUE){
    print("This line is empty")
  } else{
  temp <- as.data.frame(as.matrix(mta_master[[i]]))
  mta_master2 <- rbind(mta_master2, temp)
  }
  print(i)
}

# fix classes
mta_master2$arrival_time <- parse_date_time(mta_master2$arrival_time,  "%Y-%m-%d %H:%M:%S")
# Save data
save(mta_master2, file = "Data/Clean/mta_master.RData")
```

# Check data

```{r}
head(mta_master2)
```

# Get closest ferry and wait times

```{r get wait function}
get_wait <- function(data){
  ## Step 1: Find the closest ferry
  closest_ferry <- unlist(lapply(data$arrival, FUN = function(x) min(which((ferry_master - x)>0))))

  data$closest_ferry <- closest_ferry
  
  ## Step 2: Get ferry time stamp
  ferry_timestamp <- unlist(lapply(data$closest_ferry, FUN = function(x)ferry_times[x]))
  data$ferry_departure <- ferry_timestamp
  class(data$ferry_departure) <- c('POSIXt', 'POSIXct')
  
  ## Step 3: Obtain wait times
  data$wait_time <- as.numeric(data$ferry_departure - data$arrival)
  
  # if it looks like it's in minutes, change to seconds
  if(mean(data$wait_time)<120){
      data$wait_time <- data$wait_time*60
  } else {
    
  }

  ## Step 4: Obtain scheduled wait times
  data$wait_time_predicted <- as.numeric(data$ferry_departure - data$schedule)*60
  
  ## Step 5: Obtain scheduled closest ferries
  data$closest_ferry_predicted <- unlist(lapply(data$schedule, FUN = function(x) min(which((ferry_times - x)>0))))

  ## Step 6: Get the predicted ferry connections
  data$ferry_predicted <- unlist(lapply(data$closest_ferry, FUN = function(x)ferry_times[x]))

class(data$ferry_predicted) <- c('POSIXt', 'POSIXct')

return(data)
}
```

```{r}

```

